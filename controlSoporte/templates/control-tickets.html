{% extends 'base_admin.html' %}
{% load static %}
{% block content %}
<div class="contratosCliente">
  <h2 class="title">Mis Tickets</h2>
  <button class="btn btn-secondary newBtnElement" type="button" data-bs-toggle="modal"
    data-bs-target="#modalNvoEquipo">Nuevo</button>
  <div class="modal-equipo">
    <div class="modal" id="modalNvoEquipo" aria-hidden="true" aria-labelledby="modalNvoEquipoLabel" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title" id="modalNvoEquipoLabel">Añadir nuevo <strong>Equipo</strong></h2>
            <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="content-form">
              <form method="POST" action="{%url 'create_equipo' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-floating mb-3">
                  <input class="form-control form-control-lg" placeholder="Tipo de equipo" type="text"
                    name="tipo_equipo" required id="tipo_equipo" maxlength="45" />
                  <label class="form-label" for="tipo_equipo">Tipo de equipo</label>
                </div>
                <div class="form-floating mb-3">
                  <input class="form-control form-control-lg" placeholder="procesador" type="text" name="procesador"
                    maxlength="50" required id="procesador" />
                  <label class="form-label" for="precesador">Procesador </label>
                </div>
                <div class="form-floating mb-3">
                  <input class="form-control form-control-lg" placeholder="Tipo de disco" type="text" name="tipo_disco"
                    maxlength="80" required id="tipo_disco" />
                  <label class="form-label" for="tipo_disco">Tipo de Disco</label>
                </div>
                <div class="form-floating mb-3">
                  <input class="form-control form-control-lg" placeholder="uso del disco duro" type="text"
                    name="uso_disco" required id="uso_disco" />
                  <label class="form-label" for="uso_disco">Uso total del Disco</label>
                </div>
                <div class="form-floating mb-3">
                  <input class="form-control form-control-lg" placeholder="marca" type="text" name="marca"
                    maxlength="45" required id="marca" />
                  <label class="form-label" for="marca">Marca</label>
                </div>
                <div class="form-floating mb-3">
                  <input class="form-control form-control-lg" placeholder="capacidad de memoria ram" type="text"
                    name="ram" maxlength="13" required id="ram" />
                  <label class="form-label" for="ram">Ram</label>
                </div>
                <div class="form-floating mb-3">
                  <input class="form-control form-control-lg" placeholder="direccion Ip local" type="text"
                    name="ip_local" maxlength="13" required id="ip_local" />
                  <label class="form-label" for="ip_local">IP Local</label>
                </div>
                <div class="form-floating mb-3">
                  <input class="form-control form-control-lg" placeholder="direccion anydesk" type="text" name="anydesk"
                    maxlength="20" required id="anydesk" />
                  <label class="form-label" for="anydesk">Anydesk</label>
                </div>
                <div class="form-floating mb-3">
                  <input class="form-control form-control-lg" placeholder="Nombre de usuario del equipo" type="text"
                    name="nom_usuario" maxlength="50" required id="nom_usuario" />
                  <label class="form-label" for="nom_usuario">Nombre de Usuario del equipo</label>
                </div>
                <div class="form-floating mb-3">
                  <input class="form-control form-control-lg" placeholder="Nombre del Antivirus" type="text"
                    name="nom_antivirus" maxlength="45" required id="nom_antivirus" />
                  <label class="form-label" for="nom_antivirus">Antivirus</label>
                </div>
                <div class="form-floating mb-3">
                  <input class="form-control form-control-lg" placeholder="Vigencia del Antivirus" type="date"
                    name="vig_antivirus" required id="vig_antivirus" />
                  <label class="form-label" for="vig_antivirus">Vigencia del Antivirus</label>
                </div>
                <div class="form-floating mb-3">
                  <input class="form-control form-control-lg" placeholder="capacidad de memoria ram" type="text"
                    name="office" maxlength="13" required id="office" />
                  <label class="form-label" for="office">Paqueteria Office</label>
                </div>
                <div class="form-floating mb-3">
                  <input class="form-control form-control-lg" placeholder="capacidad de memoria ram" type="date"
                    name="vig_office" required id="vig_office" />
                  <label class="form-label" for="vig_office">Vigencia de la paqueteria office</label>
                </div>
                <div class="form-floating mb-3">
                  <input class="form-control form-control-lg" placeholder="Descripcion" type="text" name="descripcion"
                    maxlength="600" required id="descripcion" />
                  <label class="form-label" for="descripcion">Descripcion general del equipo</label>
                </div>
                <div class="form-group mb-3">
                <label class="form-label" for="nombreServicio">Servicio</label>
                <select class="form-control form-control-lg form-select" name="id_servicio" aria-describedby="emailHelp"
                  placeholder="" id="nombreServicio">
                  <option value="1">Servicio Uno</option>
                  <option value="2">Servicio Dos</option>
                  <option value="3">Servicio Tres</option>
                  <option value="4">Servicio Cuatro</option>
                  <option value="5">Servicio Cinco</option>
                </select>
            </div>
            <div class="form-group mb-3">
              <label class="form-label" for="nombreCliente">Cliente</label>
              <select class="form-control form-control-lg form-select" name="id_cliente" aria-describedby="emailHelp"
                placeholder="" id="nombreCliente">
                <!-- Las opciones se llenarán dinámicamente con JavaScript -->
              </select>
            </div>
            {% if messages %}
            <div class="row">
              {% for message in messages %}
              <div class="alert alert-{{ message.tags }}" role="alert">
                <p>{{ message }}</p>
              </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          <div class="modal-body__buttons">
            <button class="btn btn-danger" data-bs-dismiss="modal" aria-label="Close">Cancelar</button>
            <button class="btn btn-success" data-bs-target="#modalContrato" data-bs-toggle="modal"
              data-bs-dismiss="modal">Guardar</button>
          </div>
          </form>
        </div>
      </div>
    </div>
    <div class="modal fade" id="modalCliente" aria-hidden="true" aria-labelledby="modalCliente" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title" id="modalCliente">Nuevo cliente </h3>
            <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">Cliente creado!</div>
          <div class="modal-footer">
            <button class="btn btn-primary" data-bs-target="#modalCliente" data-bs-toggle="modal"
              data-bs-dismiss="modal">Cancelar </button>
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Aceptar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="content__contratos__tabs">
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active" id="usuario-tab-pane" role="tabpanel" aria-labelledby="usuario-tab"
        tabindex="0">
        <div class="content__contratos__tabs__item__body">
          <div class="table-wrapper content__contratos__tabs__item__body__table">
            <table class="display" id="myTable" cellspacing="0" width="100%">
              <thead>
                <tr>
                  <th>Id</th>
                  <th>Nombre de usuario</th>
                  <th>Paqueteria Office</th>
                  <th>Antivirus</th>
                  <th>descripcion</th>
                  <th>Detalles </th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for equipo in equipos %}
                <tr id="fila_id_{{equipo.id_equipo}}">
                  <td>{{ equipo.id_equipo }}</td>
                  <td>{{ equipo.nom_usuario}} </td>
                  <td>{{ equipo.office}} </td>
                  <td>{{ equipo.nom_antivirus}} </td>
                  <td>{{ equipo.descripcion }}</td>
                  <td>
                    <a href="{% url 'editar_equipo' equipo.id_equipo %}" data-bs-toggle="modal"
                      data-id="{{ equipo.id_equipo }}" data-bs-target="#modalEditar" title="Modificar">
                      <button class="btn btn-link newBtnElement" type="button">Ver mas ...</button></a>
                  </td>
                  <td> <a href="{% url 'editar_equipo' equipo.id_equipo %}" data-bs-toggle="modal"
                      data-id="{{ equipo.id_equipo }}" data-bs-target="#modalEditar" title="Modificar"> <i
                        class="bi bi-pencil-square"></i></a>
                    <a href="{% url 'eliminar_equipo' equipo.id_equipo %}" data-bs-toggle="modal"
                      data-bs-target="#modalEliminar" data-id="{{ equipo.id_equipo }}" title="Eliminar"> <i
                        class="bi bi-trash3-fill"></i></a></td>
                </tr>
                {% endfor %}
                <!-------------modal para modificar cliente--------------------------->
                <div class="modal-modificar-equipo">
                  <div class="modal" id="modalEditar" aria-hidden="true" aria-labelledby="modalEditarLabel"
                    tabindex="-1">
                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h2 class="modal-title" id="modalEditarLabel">Modificar <strong>Equipo</strong></h2>
                          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <div class="content-form">
                            <form action="#" id="editarEquipoForm" method="POST">
                              {% csrf_token %}
                              <div class="form-floating mb-3">
                                <input class="form-control form-control-lg" placeholder="Tipo de equipo" type="text"
                                  name="tipo_equipo" required id="tipo_equipo2" maxlength="45" />
                                <label class="form-label" for="tipo_equipo2">Tipo de equipo</label>
                              </div>
                              <div class="form-floating mb-3">
                                <input class="form-control form-control-lg" placeholder="procesador" type="text"
                                  name="procesador" maxlength="50" required id="procesador2" />
                                <label class="form-label" for="procesador2">Procesador </label>
                              </div>
                              <div class="form-floating mb-3">
                                <input class="form-control form-control-lg" placeholder="Tipo de disco" type="text"
                                  name="tipo_disco" maxlength="80" required id="tipo_disco2" />
                                <label class="form-label" for="tipo_disco2">Tipo de Disco</label>
                              </div>
                              <div class="form-floating mb-3">
                                <input class="form-control form-control-lg" placeholder="uso del disco duro" type="text"
                                  name="uso_disco" required id="uso_disco2" />
                                <label class="form-label" for="uso_disco2">Uso total del Disco</label>
                              </div>
                              <div class="form-floating mb-3">
                                <input class="form-control form-control-lg" placeholder="marca" type="text" name="marca"
                                  maxlength="45" required id="marca2" />
                                <label class="form-label" for="marca2">Marca</label>
                              </div>
                              <div class="form-floating mb-3">
                                <input class="form-control form-control-lg" placeholder="capacidad de memoria ram"
                                  type="text" name="ram" maxlength="13" required id="ram2" />
                                <label class="form-label" for="ram2">Ram</label>
                              </div>
                              <div class="form-floating mb-3">
                                <input class="form-control form-control-lg" placeholder="direccion Ip local" type="text"
                                  name="ip_local" maxlength="13" required id="ip_local2" />
                                <label class="form-label" for="ip_local2">IP Local</label>
                              </div>
                              <div class="form-floating mb-3">
                                <input class="form-control form-control-lg" placeholder="direccion anydesk" type="text"
                                  name="anydesk" maxlength="20" required id="anydesk2" />
                                <label class="form-label" for="anydesk2">Anydesk</label>
                              </div>
                              <div class="form-floating mb-3">
                                <input class="form-control form-control-lg" placeholder="Nombre de usuario del equipo"
                                  type="text" name="nom_usuario" maxlength="50" required id="nom_usuario2" />
                                <label class="form-label" for="nom_usuario2">Nombre de Usuario del equipo</label>
                              </div>
                              <div class="form-floating mb-3">
                                <input class="form-control form-control-lg" placeholder="Nombre del Antivirus"
                                  type="text" name="nom_antivirus" maxlength="45" required id="nom_antivirus2" />
                                <label class="form-label" for="nom_antivirus2">Antivirus</label>
                              </div>
                              <div class="form-floating mb-3">
                                <input class="form-control form-control-lg" placeholder="Vigencia del Antivirus"
                                  type="date" name="vig_antivirus" required id="vig_antivirus2" />
                                <label class="form-label" for="vig_antivirus2">Vigencia del Antivirus</label>
                              </div>
                              <div class="form-floating mb-3">
                                <input class="form-control form-control-lg" placeholder="capacidad de memoria ram"
                                  type="text" name="office" maxlength="13" required id="office2" />
                                <label class="form-label" for="office2">Paqueteria Office</label>
                              </div>
                              <div class="form-floating mb-3">
                                <input class="form-control form-control-lg" placeholder="capacidad de memoria ram"
                                  type="date" name="vig_office" required id="vig_office2" />
                                <label class="form-label" for="vig_office2">Vigencia de la paqueteria office</label>
                              </div>
                              <div class="form-floating mb-3">
                                <input class="form-control form-control-lg" placeholder="Descripcion" type="text"
                                  name="descripcion" maxlength="600" required id="descripcion2" />
                                <label class="form-label" for="descripcion2">Descripcion general del equipo</label>
                              </div>
                              <div class="form-group mb-3">
                                <label class="form-label" for="nombreServicio2">Servicio</label>
                                <select class="form-control form-control-lg form-select" name="id_servicio"
                                  aria-describedby="emailHelp" placeholder="" id="nombreServicio2">
                                  <option value="1">Servicio Uno</option>
                                  <option value="2">Servicio Dos</option>
                                  <option value="3">Servicio Tres</option>
                                  <option value="4">Servicio Cuatro</option>
                                  <option value="5">Servicio Cinco</option>
                                </select>
                              </div>
                              <div class="form-group mb-3">
                                <label class="form-label" for="nombreCliente2">Cliente</label>
                                <select class="form-control form-control-lg form-select" name="id_cliente"
                                  aria-describedby="emailHelp" placeholder="" id="nombreCliente2">
                                  <!-- Las opciones se llenarán dinámicamente con JavaScript -->
                                </select>
                              </div>
                              {% if messages %}
                              <div class="row">
                                {% for message in messages %}
                                <div class="alert alert-{{ message.tags }}" role="alert">
                                  <p>{{ message }}</p>
                                </div>
                                {% endfor %}
                              </div>
                              {% endif %}
                          </div>
                          <div class="modal-body__buttons">
                            <button class="btn btn-danger" data-bs-dismiss="modal" aria-label="Close">Cancelar</button>
                            <button class="btn btn-success" data-bs-target="#modalContrato" data-bs-toggle="modal"
                              data-bs-dismiss="modal">Guardar</button>
                          </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="modal fade" id="modalEliminar" aria-hidden="true" aria-labelledby="modalEliminarLabel"
                    tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="modalEliminarModalLabel">Eliminar</h5>
                          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">¿Estas seguro que desdeas eliminar?</div>
                        <div class="modal-footer">
                          <button class="btn btn-primary" data-bs-target="#modalEliminar" data-bs-toggle="modal"
                            data-bs-dismiss="modal">Cancelar </button>
                          <button id="confirmarEliminar" class="btn btn-secondary" type="button"
                            data-bs-dismiss="modal">Aceptar</button>
                        </div>
                      </div>
                    </div>
                  </div>
              </tbody>
              <script>
                $(document).ready(function () {
                  $('#myTable').DataTable();

                  $('a[data-bs-toggle="modal"]').on('click', function () {
                    var targetModalId = $(this).data('bs-target');
                    var id_equipo = $(this).data('id');
                    //Cconole.log permite visualizar en id del registro en la consola del navegador
                    //console.log('ID de la subcategoria:', id_subcategoria);

                    // Verificar si es el modal de eliminación
                    if (targetModalId === '#modalEliminar') {
                      // Actualizar el ID en el botón de eliminación
                      $('#confirmarEliminar').data('id', id_equipo);
                    } else {
                      // AJAX para cargar información del registro en el modal de edición
                      $.ajax({
                        url: '{% url "editar_equipo" id_equipo=0 %}'.replace('0', id_equipo),
                        type: 'GET',
                        data: {
                          'id_equipo': id_equipo
                        },
                        success: function (data) {
                          // Permite ver la informacion del registro en consola.
                          //console.log('Datos cargados:', data);
                          // formulario con los datos de la subcategoria
                          $('#editarEquipoForm').attr('action',
                            '{% url "editar_equipo" id_equipo=0 %}'.replace('0', id_equipo));
                          $('#tipo_equipo2').val(data.tipo_equipo);
                          $('#procesador2').val(data.procesador);
                          $('#tipo_disco2').val(data.tipo_disco);
                          $('#uso_disco2').val(data.uso_disco);
                          $('#marca2').val(data.marca);
                          $('#ram2').val(data.ram);
                          $('#ip_local2').val(data.ip_local);
                          $('#anydesk2').val(data.anydesk);
                          $('#nom_usuario2').val(data.nom_usuario);
                          $('#nom_antivirus2').val(data.nom_antivirus);
                          $('#vig_antivirus2').val(data.vig_antivirus);
                          $('#office2').val(data.office);
                          $('#vig_office2').val(data.vig_office);
                          $('#descripcion2').val(data.descripcion);
                          $('#nombreServicio2').val(data.id_servicio);
                          $('#nombreCliente2').val(data.id_cliente);

                          var idServicio = $('#nombreServicio2').val();
                          var selectClientes = $('#nombreCliente2');
                          llenarClientes(idServicio, selectClientes);
                          //$('#nombreServicio2').val(data.id_servicio);  // Actualizar el campo id_categoria
                          // Muestra el modal
                          //$('#modalEditar').modal('show');
                          $('#modalEditar').on('show.bs.modal', function () {
                            // Resto del código...

                            // Llenar subcategorías al abrir el modal de edición
                            var idServicio = $('#nombreServicio2').val();
                            var selectClientes = $('#nombreCliente2');
                            llenarClientes(idServicio, selectClientes);
                          });
                        },
                        error: function (xhr, status, error) {
                          console.error('Error al cargar la información del registro:', error);
                          alert('Error al cargar la información del registro.');
                        }
                      });

                    }
                  });

                  // Manejar clic en el botón de eliminación
                  $('#confirmarEliminar').on('click', function () {
                    var id_equipo = $(this).data('id');
                    console.log('ID del producto a eliminar:', id_equipo);
                    if (id_equipo !== undefined) {
                      $.ajax({
                        url: '{% url "eliminar_equipo" id_equipo=0 %}'.replace('0', id_equipo),
                        type: 'POST',
                        dataType: 'json',
                        data: {
                          'id_equipo': id_equipo
                        },
                        success: function (response) {
                          console.log('Respuesta del servidor:', response);
                          alert('Registro eliminado correctamente');
                          // Cerrar el modal después de la eliminación
                          $('#modalEliminar').modal('hide');
                          // Recargar la página después de la eliminación
                          //location.reload();
                          // Eliminar la fila correspondiente de la tabla
                          var table = $('#myTable').DataTable();
                          table.row('#fila_id_' + id_equipo).remove().draw();
                        },
                        error: function (xhr, status, error) {
                          console.error('Error al eliminar el registro:', error);
                          alert('Error al eliminar el registro.');
                        }
                      });

                    } else {
                      console.error('ID de cliente no definido al intentar eliminar el registro.');
                      alert('Error al eliminar el registro: ID no definido.');
                    }
                  });

                  // Función para llenar el select de subcategorías
                  function llenarClientes(idServicio, selectClientes) {
                    $.ajax({
                      url: '/controlSoporte/obtener_clientes/',
                      type: 'GET',
                      data: {
                        'id_servicio': idServicio
                      },
                      success: function (data) {
                        // console.log('Subcategorías cargadas:', data);

                        if (data !== undefined) {
                          // Limpia las opciones existentes en el select
                          selectClientes.empty();

                          // Agrega las nuevas opciones basadas en la respuesta del servidor
                          for (var i = 0; i < data.length; i++) {
                            selectClientes.append('<option value="' + data[i].id + '">' + data[i]
                              .nombre + '</option>');
                          }
                        } else {
                          console.error('El array de clientes no está definido en la respuesta.');
                        }
                      },
                      error: function (xhr, status, error) {
                        console.error('Error al cargar clientes:', error);
                        alert('Error al cargar clientes.');
                      }
                    });
                  }

                  // Evento al abrir el modal de agregar
                  $('#modalAgregar').on('show.bs.modal', function () {
                    // Llenar subcategorías al abrir el modal de agregar
                    var idServicio = $('#nombreServicio')
                  .val(); // Obtener el valor de la categoría seleccionada
                    var selectClientes = $('#nombreCliente'); // Seleccionar el elemento select de subcategorías
                    llenarClientes(idServicio, selectClientes);
                  });

                  // Resto del código...

                  // Evento al cambiar la categoría en el formulario de agregar
                  $('#nombreServicio').change(function () {
                    var idServicio = $(this).val();
                    var selectClientes = $('#nombreCliente');
                    llenarClientes(idServicio, selectClientes);
                  });
                });
              </script>
            </table>
          </div>
        </div>
        <button class="btn btn-exit" onclick="paginaInicio()" id="salir">Salir</button>
      </div>
    </div>
    <script src="{% static './js/inicio.js' %}"></script>
  </div>
</div>
{% endblock %}